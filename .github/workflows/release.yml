# name: CHM Release

# on:
#   push:
#     tags:
#       - "v*.*.*"

# permissions:
#   contents: write

# jobs:
#   build:
#     name: Build CHM binaries
#     runs-on: ubuntu-latest

#     strategy:
#       fail-fast: false
#       matrix:
#         target:
#           - x86_64-unknown-linux-gnu
#     env:
#       SQLX_OFFLINE: "true"
#       RUSTFLAGS: "-C debuginfo=0"

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Install Rust
#         uses: dtolnay/rust-toolchain@stable
#         with:
#           targets: ${{ matrix.target }}

#       # - name: Run tests
#       #   run: cargo test --workspace --locked

#       - name: Build workspace in release mode
#         run: cargo build --workspace --release --locked --target ${{ matrix.target }}

#       - name: Collect CHM binaries
#         run: |
#           set -euxo pipefail
#           OUT_DIR="dist/${{ matrix.target }}"
#           mkdir -p "$OUT_DIR"
#           BIN_DIR="target/${{ matrix.target }}/release"
#           ls -lh "$BIN_DIR"
#           for bin in \
#             CHMcd \
#             CHM_API \
#             CHM_agentd \
#             CHM_hostd \
#             CHM_ldapd \
#             CHM_dhcpd \
#             CHMmCA \
#             CHMmDNS
#           do
#             if [ -f "${BIN_DIR}/${bin}" ]; then
#               cp "${BIN_DIR}/${bin}" "${OUT_DIR}/${bin}"
#             else
#               echo "WARN: binary ${bin} not found for target ${{ matrix.target }} (skip)"
#             fi
#           done

#           echo "Collected binaries in ${OUT_DIR}:"
#           ls -lh "${OUT_DIR}"

#       - name: Tarball binaries
#         run: |
#           set -euxo pipefail
#           cd dist
#           tar czf "CHM-${{ matrix.target }}.tar.gz" "${{ matrix.target }}"
#           ls -lh

#       - name: Upload artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: CHM-${{ matrix.target }}
#           path: dist/CHM-${{ matrix.target }}.tar.gz

#   github-release:
#     name: Create GitHub Release
#     runs-on: ubuntu-latest
#     needs: build

#     steps:
#       - name: Download all artifacts
#         uses: actions/download-artifact@v4
#         with:
#           path: ./dist

#       - name: Create GitHub Release
#         uses: softprops/action-gh-release@v2
#         with:
#           files: dist/**/*.tar.gz
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: CHM Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    name: Build CHM binaries
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu

    env:
      SQLX_OFFLINE: "true"
      RUSTFLAGS: "-C debuginfo=0"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # - name: Run tests
      #   run: cargo test --workspace --locked

      - name: Build workspace in release mode
        run: cargo build --workspace --release --locked --target ${{ matrix.target }}

      - name: Collect CHM binaries
        run: |
          set -euxo pipefail

          OUT_DIR="dist/${{ matrix.target }}"
          mkdir -p "$OUT_DIR"
          BIN_DIR="target/${{ matrix.target }}/release"

          echo "Built binaries in ${BIN_DIR}:"
          ls -lh "$BIN_DIR"

          for bin in \
            CHMcd \
            CHM_API \
            CHM_agentd \
            CHM_hostd \
            CHM_ldapd \
            CHM_dhcpd \
            CHMmCA \
            CHMmDNS
          do
            if [ -f "${BIN_DIR}/${bin}" ]; then
              # 檔名加上 target，避免之後多平台撞名
              cp "${BIN_DIR}/${bin}" "${OUT_DIR}/${bin}-${{ matrix.target }}"
            else
              echo "WARN: binary ${bin} not found for target ${{ matrix.target }} (skip)"
            fi
          done

          echo "Collected binaries in ${OUT_DIR}:"
          ls -lh "${OUT_DIR}"
      
      - name: Upload binaries as artifact
        uses: actions/upload-artifact@v4
        with:
          name: CHM-${{ matrix.target }}
          path: dist/${{ matrix.target }}/*
          if-no-files-found: error

  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: CHM-*
          path: ./dist
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
